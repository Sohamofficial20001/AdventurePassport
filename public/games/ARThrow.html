<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Stationary Bin AR</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        canvas.a-canvas {
            touch-action: none !important;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">

    <div id="overlay"
        style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:1000; background:rgba(0,0,0,0.8); display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; font-family:sans-serif;">
        <button onclick="start()"
            style="padding:20px 40px; font-size:24px; border-radius:10px; border:none; background:#e67e22; color:white;">SET
            BIN & PLAY</button>
        <p style="margin-top:10px">Look straight ahead before clicking</p>
    </div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;"
        vr-mode-ui="enabled: false" renderer="logarithmicDepthBuffer: true">

        <a-entity id="world-root">

            <a-entity id="basket-center" position="0 -1.5 -7">
                <a-cylinder color="#e74c3c" height="1" radius="0.65" open-ended="true" side="double"></a-cylinder>
                <a-text value="Veggies" align="center" position="0 1.5 0" scale="2 2 2"></a-text>
            </a-entity>

            <a-entity id="basket-left" position="-2.5 -1.5 -7">
                <a-cylinder color="#3498db" height="1" radius="0.65" open-ended="true" side="double"></a-cylinder>
                <a-text value="Fruits" align="center" position="0 1.5 0" scale="2 2 2"></a-text>
            </a-entity>

            <a-entity id="basket-right" position="2.5 -1.5 -7">
                <a-cylinder color="#f1c40f" height="1" radius="0.65" open-ended="true" side="double"></a-cylinder>
                <a-text value="KuchAur" align="center" position="0 1.5 0" scale="2 2 2"></a-text>
            </a-entity>

        </a-entity>

        <a-entity id="camera-rig" position="0 1.6 0">
            <a-camera id="mainCam" look-controls="enabled: true; touchEnabled: false; magicWindowTrackingEnabled: true"
                wasd-controls-enabled="false">
                <a-entity cursor="fuse: false" position="0 0 -1"
                    geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
                    material="color: #FFF; shader: flat">
                </a-entity>
            </a-camera>
        </a-entity>

    </a-scene>

    <div id="score-container"
        style="position:fixed; top:20px; left:20px; z-index:1001; pointer-events:none; font-family:sans-serif; text-shadow:2px 2px 4px #000;">
        <div style="color:#2ecc71; font-size:12px; font-weight:bold;">SCORE</div>
        <div id="score-val" style="color:white; font-size:32px; font-weight:bold;">0</div>
    </div>

    <div id="target-container"
        style="position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:1001; text-align:center; font-family:sans-serif; pointer-events:none;">
        <div style="color:#67e8f9; font-size:12px; font-weight:bold;">HOLDING</div>
        <div id="current-label-ui"
            style="color:white; font-size:28px; font-weight:bold; background:rgba(0,0,0,0.3); padding:5px 20px; border-radius:15px;">
            ---</div>
    </div>

    <div id="timer-container"
        style="position:fixed; top:20px; right:20px; z-index:1001; pointer-events:none; font-family:sans-serif; text-shadow:2px 2px 4px #000; text-align:right;">
        <div style="color:#e67e22; font-size:12px; font-weight:bold;">TIME</div>
        <div id="time-val" style="color:white; font-size:32px; font-weight:bold;">60</div>
    </div>

    <script>
        let score = 0;
        let timeLeft = 60;
        let canThrow = false;
        let gameActive = false;
        let timerInterval;
        let currentItem = null;

        const scene = document.querySelector('a-scene');
        const cam = document.querySelector('#mainCam');

        const gameConfig = [
            { label: "Apple", target: "basket-left" },
            { label: "Banana", target: "basket-left" },
            { label: "Carrot", target: "basket-center" },
            { label: "Broccoli", target: "basket-center" },
            { label: "Lollipop", target: "basket-right" },
            { label: "Chocolate", target: "basket-right" }
        ];

        function prepareNextItem() {
            currentItem = gameConfig[Math.floor(Math.random() * gameConfig.length)];
            document.getElementById('current-label-ui').innerText = currentItem.label.toUpperCase();
        }

        function start() {
            document.getElementById('overlay').style.display = 'none';
            score = 0;
            timeLeft = 60;
            gameActive = true;
            canThrow = true;

            document.getElementById('score-val').innerText = "0";
            document.getElementById('time-val').innerText = "60";

            prepareNextItem();
            startTimer();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const timerEl = document.getElementById('time-val');
                timerEl.innerText = timeLeft;

                if (timeLeft <= 10) {
                    timerEl.style.color = "#ff3333";
                }

                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        // ⭐⭐⭐ UPDATED — SEND RESULT TO REACT APP AND CLOSE TAB
        function endGame() {
            clearInterval(timerInterval);
            gameActive = false;
            canThrow = false;

            // ⭐ define win rule
            const didWin = score >= 30;

            // ⭐ notify opener (to React app)
            if (window.opener) {
                window.opener.postMessage({
                    type: "AR_GAME_RESULT",
                    // score: score,
                    win: didWin,
                    metadata: {
                        score: score,
                        minScoreToWin: 30,
                        timePlayed: 60,
                    }
                }, "*");
            }

            // ⭐ optionally show a small message
            // alert("Final Score: " + score);

            // ⭐ close AR tab automatically
            window.close();
        }

        // --- swipe logic remains unchanged ---
        let startX, startY;
        window.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });

        window.addEventListener('touchend', (e) => {
            if (!canThrow || !gameActive) return;

            let diffX = e.changedTouches[0].clientX - startX;
            let diffY = startY - e.changedTouches[0].clientY;

            if (diffY > 60) {
                canThrow = false;
                let horizontalTilt = diffX / window.innerWidth;
                throwBall(horizontalTilt);
                setTimeout(() => { if (gameActive) canThrow = true; }, 800);
            }
        });

        function throwBall(tilt) {
            const itemBeingThrown = currentItem;

            const wrapper = document.createElement('a-entity');
            const ball = document.createElement('a-sphere');

            ball.setAttribute('radius', '0.15');
            ball.setAttribute('color', 'white');
            wrapper.appendChild(ball);
            scene.appendChild(wrapper);

            prepareNextItem();

            const startPos = new THREE.Vector3();
            cam.object3D.getWorldPosition(startPos);

            const direction = new THREE.Vector3(0, 0, -1);
            direction.applyQuaternion(cam.object3D.quaternion);

            const sideVector = new THREE.Vector3(1, 0, 0);
            sideVector.applyQuaternion(cam.object3D.quaternion);

            direction.addScaledVector(sideVector, tilt * 2);

            const distance = 8;
            const endPos = {
                x: startPos.x + direction.x * distance,
                y: -1.5,
                z: startPos.z + direction.z * distance
            };

            wrapper.setAttribute('animation', { property: 'position', to: `${endPos.x} ${endPos.y} ${endPos.z}`, dur: 1000 });

            setTimeout(() => {
                const buckets = ['basket-left', 'basket-center', 'basket-right'];

                buckets.forEach(id => {
                    const bucket = document.getElementById(id);
                    const bPos = bucket.object3D.position;

                    const dist = Math.sqrt(
                        Math.pow(endPos.x - bPos.x, 2) +
                        Math.pow(endPos.z - bPos.z, 2)
                    );

                    if (dist < 0.9) {
                        if (id === itemBeingThrown.target) {
                            score += 10;
                            updateScoreUI();
                        }
                    }
                });

                if (wrapper.parentNode) wrapper.parentNode.removeChild(wrapper);
            }, 1100);
        }

        function updateScoreUI() {
            document.getElementById('score-val').innerText = score;
        }
    </script>

</body>

</html>